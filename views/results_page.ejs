<!DOCTYPE html>
<html>
<head>
    <title>Election Results</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-dark bg-transparent mb-4 pt-3">
        <div class="container">
            <a href="/dashboard" class="btn btn-outline-light">&larr; Back to Dashboard</a>
            <span class="navbar-brand mb-0 h1"><%= election.title %> - Results</span>
            <div style="width: 80px;"></div> </div>
    </nav>
    <div class="container">
        <div class="card main-card mb-4">
            <div class="card-body">
                <div class="row justify-content-center">
                    <div class="col-md-6 col-lg-5 mb-4 text-center">
                        <h5 class="text-muted mb-3">Vote Distribution</h5>
                        <div style="max-width: 350px; margin: 0 auto;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="col-md-6 col-lg-5 mb-4 text-center">
                        <h5 class="text-muted mb-3">Vote Counts</h5>
                        <div style="max-width: 350px; margin: 0 auto;">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card main-card">
            <div class="card-header bg-white border-0 pt-4">
                <h4>Detailed Statistics</h4>
            </div>
            <div class="card-body">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Candidate / Option</th>
                            <th>Votes Received</th>
                            <th>Percentage</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                           const totalVotes = election.candidates.reduce((acc, c) => acc + c.voteCount, 0); 
                           const maxVotes = Math.max(...election.candidates.map(c => c.voteCount));
                        %>
                        <% election.candidates.forEach(function(candidate) { %>
                            <% const isWinner = totalVotes > 0 && candidate.voteCount === maxVotes; %>
                            <tr class="<%= isWinner ? 'table-success' : '' %>">
                                <td class="fw-bold"><%= candidate.name %></td>
                                <td><%= candidate.voteCount %></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 6px;">
                                            <div class="progress-bar" role="progressbar" style="width: <%= totalVotes > 0 ? (candidate.voteCount/totalVotes)*100 : 0 %>%"></div>
                                        </div>
                                        <span><%= totalVotes > 0 ? ((candidate.voteCount / totalVotes) * 100).toFixed(1) : 0 %>%</span>
                                    </div>
                                </td>
                                <td>
                                    <% if (isWinner && totalVotes > 0) { %>
                                        <span class="badge bg-success">Leading</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary">-</span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const candidates = <%- JSON.stringify(election.candidates) %>;
        const labels = candidates.map(c => c.name);
        const data = candidates.map(c => c.voteCount);
        const backgroundColors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'];

        new Chart(document.getElementById('pieChart').getContext('2d'), {
            type: 'pie',
            data: { labels: labels, datasets: [{ data: data, backgroundColor: backgroundColors }] },
            options: { responsive: true }
        });

        new Chart(document.getElementById('barChart').getContext('2d'), {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Votes', data: data, backgroundColor: backgroundColors }] },
            options: { 
                responsive: true,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
                plugins: { legend: { display: false } }
            }
        });
    </script>
    function exportToCSV() {
        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Candidate,Votes\n"; 
    
        const candidates = <%- JSON.stringify(election.candidates) %>;
    
        candidates.forEach(function(c) {
            csvContent += c.name + "," + c.voteCount + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "election_results.csv");
        document.body.appendChild(link);
        link.click();
   }
</body>
</html>
